# è¿™ä¸ªå·¥ä½œæµä½¿ç”¨GitHubæœªè®¤è¯çš„æ“ä½œã€‚
# è¿™äº›ç”±ç¬¬ä¸‰æ–¹æä¾›ï¼Œå¹¶å—åˆ°ç‹¬ç«‹çš„æœåŠ¡æ¡æ¬¾ã€éšç§æ”¿ç­–å’Œæ”¯æŒæ–‡æ¡£çš„ç®¡ç†ã€‚

# ğŸ’ OpenShift Starterå·¥ä½œæµå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# - æ£€å‡ºæ‚¨çš„å­˜å‚¨åº“
# - æ‰§è¡Œå®¹å™¨é•œåƒæ„å»º
# - å°†æ„å»ºçš„é•œåƒæ¨é€åˆ°GitHubå®¹å™¨æ³¨å†Œè¡¨ï¼ˆGHCRï¼‰
# - ç™»å½•åˆ°æ‚¨çš„OpenShifté›†ç¾¤
# - ä»é•œåƒåˆ›å»ºä¸€ä¸ªOpenShiftåº”ç”¨å¹¶å°†å…¶æš´éœ²åˆ°äº’è”ç½‘ä¸Š

# â„¹ï¸ ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤é…ç½®æ‚¨çš„å­˜å‚¨åº“å’Œå·¥ä½œæµï¼š
# 1. è®¿é—®OpenShifté›†ç¾¤ã€‚è¯·å‚é˜… https://www.openshift.com/try
# 2. åˆ›å»ºOPENSHIFT_SERVERå’ŒOPENSHIFT_TOKENå­˜å‚¨åº“æœºå¯†ã€‚è¯·å‚é˜…ï¼š
#    - https://github.com/redhat-actions/oc-login#readme
#    - https://docs.github.com/en/actions/reference/encrypted-secrets
#    - https://cli.github.com/manual/gh_secret_set
# 3. ï¼ˆå¯é€‰ï¼‰æ ¹æ®é¡¹ç›®è¦æ±‚ç¼–è¾‘é¡¶å±‚çš„ 'env' éƒ¨åˆ†ï¼Œå¦‚ 'ğŸ–Šï¸' æ ‡æ³¨çš„éƒ¨åˆ†ã€‚
# 4. ï¼ˆå¯é€‰ï¼‰ç¼–è¾‘ build-image æ­¥éª¤ä»¥æ„å»ºæ‚¨çš„é¡¹ç›®ã€‚
#    é»˜è®¤æ„å»ºç±»å‹æ˜¯ä½¿ç”¨å­˜å‚¨åº“æ ¹ç›®å½•ä¸‹çš„ Dockerfileï¼Œä½†å¯ä»¥æ›¿æ¢ä¸ºä¸åŒçš„æ–‡ä»¶ã€æºåˆ°é•œåƒæ„å»ºæˆ–é€æ­¥ buildah æ„å»ºã€‚
# 5. æäº¤å¹¶æ¨é€å·¥ä½œæµæ–‡ä»¶åˆ°é»˜è®¤åˆ†æ”¯ä»¥è§¦å‘å·¥ä½œæµè¿è¡Œã€‚

# ğŸ‘‹ è®¿é—®æˆ‘ä»¬çš„GitHubç»„ç»‡ https://github.com/redhat-actions/ æŸ¥çœ‹æˆ‘ä»¬çš„æ“ä½œå¹¶æä¾›åé¦ˆã€‚

name: OpenShift

env:
  # ğŸ–Šï¸ ç¼–è¾‘æ‚¨çš„å­˜å‚¨åº“æœºå¯†ä»¥ç™»å½•åˆ°æ‚¨çš„OpenShifté›†ç¾¤å¹¶è®¾ç½®ä¸Šä¸‹æ–‡ã€‚
  # è¯·å‚é˜… https://github.com/redhat-actions/oc-login#readme äº†è§£å¦‚ä½•æ£€ç´¢è¿™äº›å€¼ã€‚
  # è¦è·å–æ°¸ä¹…ä»¤ç‰Œï¼Œè¯·å‚é˜… https://github.com/redhat-actions/oc-login/wiki/Using-a-Service-Account-for-GitHub-Actions
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  # ğŸ–Šï¸ ç¼–è¾‘ç™»å½•åè®¾ç½® kube ä¸Šä¸‹æ–‡çš„å‘½åç©ºé—´ã€‚ç•™ç©ºä»¥ä½¿ç”¨ç”¨æˆ·çš„é»˜è®¤å‘½åç©ºé—´ã€‚
  OPENSHIFT_NAMESPACE: ""

  # ğŸ–Šï¸ ç¼–è¾‘ä¸ºæ‚¨çš„OpenShiftåº”ç”¨è®¾ç½®åç§°ï¼Œå¦åˆ™å°†ç”Ÿæˆé»˜è®¤åç§°ã€‚
  APP_NAME: ""

  # ğŸ–Šï¸ ç¼–è¾‘åº”ç”¨ç¨‹åºåº”è¯¥è®¿é—®çš„ç«¯å£ã€‚
  # å¦‚æœå®¹å™¨é•œåƒæ°å¥½å…¬å¼€äº†ä¸€ä¸ªç«¯å£ï¼Œåˆ™å¯ä»¥ç•™ç©ºã€‚
  # å‚é˜… https://github.com/redhat-actions/oc-new-app çš„ 'port' è¾“å…¥
  APP_PORT: ""

  # ğŸ–Šï¸ ç¼–è¾‘ä»¥æ›´æ”¹é•œåƒæ³¨å†Œè¡¨è®¾ç½®ã€‚
  # æ”¯æŒGHCRã€Quay.ioå’ŒDocker Hubç­‰æ³¨å†Œè¡¨ã€‚
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  IMAGE_REGISTRY_USER: ${{ github.actor }}
  IMAGE_REGISTRY_PASSWORD: ${{ github.token }}

  # ğŸ–Šï¸ ç¼–è¾‘ä»¥æŒ‡å®šå®¹å™¨é•œåƒçš„è‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¦åˆ™å°†ç”Ÿæˆé»˜è®¤æ ‡ç­¾ã€‚
  IMAGE_TAGS: ""

on:
  # https://docs.github.com/en/actions/reference/events-that-trigger-workflows
  workflow_dispatch:
  push:
    # ç¼–è¾‘ä»¥åœ¨æ¯æ¬¡æ¨é€æ—¶æ„å»ºå’Œéƒ¨ç½²çš„åˆ†æ”¯ä¸Šæ„å»ºã€‚
    branches: [ $default-branch ]

jobs:
  # ğŸ–Šï¸ å¦‚æœæ‚¨æƒ³åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºä¹‹å‰å¯¹é¡¹ç›®è¿è¡Œæ¼æ´æ£€æŸ¥ï¼Œè¯·ç¼–è¾‘è¿™éƒ¨åˆ†ã€‚
  # è¯·å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„CRDAæ‰«æä½œä¸šå¹¶åœ¨å·¥ä½œæµä¸­é…ç½®å®ƒã€‚
  #
  # TODO: ç¡®ä¿ä» 'Actions' é€‰é¡¹å¡æ·»åŠ  'CRDA Scan' èµ·å§‹å·¥ä½œæµã€‚
  # æ·»åŠ æ–°èµ·å§‹å·¥ä½œæµçš„æŒ‡å—è¯·è®¿é—® https://docs.github.com/en/github-ae@latest/actions/using-workflows/using-starter-workflows

  crda-scan:
    uses: ./.github/workflows/crda.yml
    secrets:
      CRDA_KEY: ${{ secrets.CRDA_KEY }}
      # SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}       # ä½¿ç”¨SNYK_TOKENæˆ–CRDA_KEY

  openshift-ci-cd:
    # ğŸ–Šï¸ å¦‚æœæ‚¨åœ¨ä¸Šé¢ä½¿ç”¨äº†CRDAæ‰«ææ­¥éª¤ï¼Œè¯·å–æ¶ˆæ³¨é‡Šæ­¤è¡Œ
    # needs: crda-scan
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ°OpenShift
    runs-on: ubuntu-20.04
    environment: production

    outputs:
      ROUTE: ${{ steps.deploy-and-expose.outputs.route }}
      SELECTOR: ${{ steps.deploy-and-expose.outputs.selector }}

    steps:
    - name: æ£€æŸ¥æ‰€éœ€çš„æœºå¯†
      uses: actions/github-script@v6
      with:
        script: |
          const secrets = {
            OPENSHIFT_SERVER: `${{ secrets.OPENSHIFT_SERVER }}`,
            OPENSHIFT_TOKEN: `${{ secrets.OPENSHIFT_TOKEN }}`,
          };

          const GHCR = "ghcr.io";
          if (`${{ env.IMAGE_REGISTRY }}`.startsWith(GHCR)) {
            core.info(`Image registry is ${GHCR} - no registry password required`);
          }
          else {
            core.info("A registry password is required");
            secrets["IMAGE_REGISTRY_PASSWORD"] = `${{ secrets.IMAGE_REGISTRY_PASSWORD }}`;
          }

          const missingSecrets = Object.entries(secrets).filter(([ name, value ]) => {
            if (value.length === 0) {
              core.error(`Secret "${name}" is not set`);
              return true;
            }
            core.info(`âœ”ï¸ Secret "${name}" is set`);
            return false;
          });

          if (missingSecrets.length > 0) {
            core.setFailed(`âŒ At least one required secret is not set in the repository. \n` +
              "You can add it using:\n" +
              "GitHub UI: https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository \n" +
              "GitHub CLI: https://cli.github.com/manual/gh_secret_set \n" +
              "Also, refer to https://github.com/redhat-actions/oc-login#getting-started-with-the-action-or-see-example");
          }
          else {
            core.info(`âœ… All the required secrets are set`);
          }

    - name: æ£€å‡ºå­˜å‚¨åº“
      uses: actions/checkout@v3

    - name: ç¡®å®šåº”ç”¨ç¨‹åºåç§°
      if: env.APP_NAME == ''
      run: |
        echo "APP_NAME=$(basename $PWD)" | tee -a $GITHUB_ENV

    - name: ç¡®å®šé•œåƒæ ‡ç­¾
      if: env.IMAGE_TAGS == ''
      run: |
        echo "IMAGE_TAGS=latest ${GITHUB_SHA::12}" | tee -a $GITHUB_ENV

    # https://github.com/redhat-actions/buildah-build#readme
    - name: ä»Dockerfileæ„å»º
      id: build-image
      uses: redhat-actions/buildah-build@v2
      with:
        image: ${{ env.APP_NAME }}
        tags: ${{ env.IMAGE_TAGS }}

        # å¦‚æœæ²¡æœ‰Dockerfile/Containerfileï¼Œè¯·å‚é˜… https://github.com/redhat-actions/buildah-build#scratch-build-inputs
        # æˆ–ä½¿ç”¨ https://github.com/redhat-actions/s2i-build è¿›è¡Œæºåˆ°é•œåƒæ„å»ºã€‚
        # æˆ–è€…ï¼Œå°†å…¶æŒ‡å‘å­˜å‚¨åº“æ ¹ç›®å½•ç›¸å¯¹äºçš„ Dockerfile/Containerfileã€‚
        dockerfiles: |
          ./Dockerfile

    # https://github.com/redhat-actions/push-to-registry#readme
    - name: æ¨é€åˆ°æ³¨å†Œè¡¨
      id: push-image
      uses: redhat-actions/push-to-registry@v2
      with:
        image: ${{ steps.build-image.outputs.image }}
        tags: ${{ steps.build-image.outputs.tags }}
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ env.IMAGE_REGISTRY_USER }}
        password: ${{ env.IMAGE_REGISTRY_PASSWORD }}

    # å›¾åƒæ¨é€åˆ°çš„è·¯å¾„ç°åœ¨å­˜å‚¨åœ¨ ${{ steps.push-image.outputs.registry-path }} ä¸­

    - name: å®‰è£…oc
      uses: redhat-actions/openshift-tools-installer@v1
      with:
        oc: 4

    # https://github.com/redhat-actions/oc-login#readme
    - name: ç™»å½•åˆ°OpenShift
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ env.OPENSHIFT_SERVER }}
        openshift_token: ${{ env.OPENSHIFT_TOKEN }}
        insecure_skip_tls_verify: true
        namespace: ${{ env.OPENSHIFT_NAMESPACE }}

    # æ­¤æ­¥éª¤åº”åˆ›å»ºéƒ¨ç½²ã€æœåŠ¡å’Œè·¯ç”±ä»¥è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åºå¹¶å°†å…¶æš´éœ²åˆ°äº’è”ç½‘ä¸Šã€‚
    # https://github.com/redhat-actions/oc-new-app#readme
    - name: åˆ›å»ºå’Œæš´éœ²åº”ç”¨ç¨‹åº
      id: deploy-and-expose
      uses: redhat-actions/oc-new-app@v1
      with:
        app_name: ${{ env.APP_NAME }}
        image: ${{ steps.push-image.outputs.registry-path }}
        namespace: ${{ env.OPENSHIFT_NAMESPACE }}
        port: ${{ env.APP_PORT }}

    - name: æ‰“å°åº”ç”¨ç¨‹åºURL
      env:
        ROUTE: ${{ steps.deploy-and-expose.outputs.route }}
        SELECTOR: ${{ steps.deploy-and-expose.outputs.selector }}
      run: |
        [[ -n ${{ env.ROUTE }} ]] || (echo "åœ¨ä¸Šä¸€æ­¥ä¸­ç¡®å®šåº”ç”¨ç¨‹åºè·¯ç”±å¤±è´¥"; exit 1)
        echo
        echo "======================== æ‚¨çš„åº”ç”¨ç¨‹åºä½äºä»¥ä¸‹ä½ç½®ï¼š========================"
        echo ${{ env.ROUTE }}
        echo "==================================================================================="
        echo
        echo "æ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ \"oc delete all --selector='${{ env.SELECTOR }}'\" å…³é—­"
