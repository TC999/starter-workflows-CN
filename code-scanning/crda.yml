# è¯¥å·¥ä½œæµä½¿ç”¨GitHubæœªç»è®¤è¯çš„æ“ä½œã€‚
# è¿™äº›æ“ä½œç”±ç¬¬ä¸‰æ–¹æä¾›ï¼Œå¹¶å—å•ç‹¬çš„æœåŠ¡æ¡æ¬¾ã€éšç§æ”¿ç­–å’Œæ”¯æŒæ–‡æ¡£çº¦æŸã€‚

# æ­¤å·¥ä½œæµä½¿ç”¨ Red Hat CodeReady Dependency Analytics å¯¹æºä»£ç è¿›è¡Œé™æ€åˆ†æã€‚

# è§¦å‘æ‰«æçš„æ¡ä»¶ï¼š
# 1. åœ¨é»˜è®¤åˆ†æ”¯å’Œå—ä¿æŠ¤åˆ†æ”¯ä¸Šçš„æ¯æ¬¡æ¨é€
# 2. é’ˆå¯¹é»˜è®¤åˆ†æ”¯çš„æ¯æ¬¡æ‹‰å–è¯·æ±‚
# 3. æ¯å‘¨å®šæœŸè®¡åˆ’
# 4. æ‰‹åŠ¨è§¦å‘ï¼ŒæŒ‰éœ€ä½¿ç”¨ "workflow_dispatch" äº‹ä»¶

# ğŸ’ CRDA Starter å·¥ä½œæµå°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# - æ£€å‡ºæ‚¨çš„å­˜å‚¨åº“
# - è®¾ç½®æ‰€éœ€çš„å·¥å…·æ ˆ
# - å®‰è£… CRDA å‘½ä»¤è¡Œå·¥å…·
# - è‡ªåŠ¨æ£€æµ‹æ¸…å•æ–‡ä»¶å¹¶å®‰è£…é¡¹ç›®çš„ä¾èµ–é¡¹
# - ä½¿ç”¨ CRDA æ‰§è¡Œå®‰å…¨æ‰«æ
# - å°† SARIF ç»“æœä¸Šä¼ åˆ° GitHub Code Scanningï¼Œå¯åœ¨å®‰å…¨é€‰é¡¹å¡ä¸‹æŸ¥çœ‹
# - å¯é€‰åœ°å°† SARIF æ–‡ä»¶ä½œä¸ºæœªæ¥å‚è€ƒä¸Šä¼ ä¸ºæ„ä»¶

# â„¹ï¸ é…ç½®å­˜å‚¨åº“å’Œå·¥ä½œæµçš„æ­¥éª¤å¦‚ä¸‹ï¼š
# 1. æ ¹æ®é¡¹ç›®çš„è¦æ±‚è®¾ç½®å·¥å…·æ ˆã€‚
#    å‚è€ƒï¼šhttps://github.com/redhat-actions/crda/#1-set-up-the-tool-stack
# 2. (å¯é€‰) CRDA æ“ä½œå°è¯•æ£€æµ‹è¯­è¨€å¹¶ä¸ºæ‚¨çš„é¡¹ç›®å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚
#    å¦‚æœæ‚¨çš„é¡¹ç›®ä¸ç¬¦åˆæ­¤å¤„ https://github.com/redhat-actions/crda/#3-installing-dependencies æåˆ°çš„é»˜è®¤ä¾èµ–é¡¹å®‰è£…å‘½ä»¤ï¼Œ
#    è¯·ä½¿ç”¨æ‰€éœ€çš„è¾“å…¥è®¾ç½®ç›¸åŒ
# 3. (å¯é€‰) CRDA æ“ä½œå°è¯•æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸­æ˜¯å¦å­˜åœ¨æ¸…å•æ–‡ä»¶ï¼Œå¹¶æŒ‰ç…§æ­¤å¤„ https://github.com/redhat-actions/crda/#3-installing-dependencies æåˆ°çš„é»˜è®¤æ–‡ä»¶å‘½åè¿›è¡Œæ£€æµ‹ã€‚
#    å¦‚æœä¸é»˜è®¤å€¼ä¸ç¬¦ï¼Œè¯·ä½¿ç”¨æ‰€éœ€çš„è¾“å…¥è®¾ç½®ç›¸åŒ
# 4. è®¾ç½®èº«ä»½éªŒè¯ - åˆ›å»º CRDA_KEY æˆ– SNYK_TOKENã€‚
#    å‚è€ƒï¼šhttps://github.com/redhat-actions/crda/#4-set-up-authentication
# 5. (å¯é€‰) å°† SARIF æ–‡ä»¶ä½œä¸ºæ„ä»¶ä¸Šä¼ ä»¥ä¾›ä¸‹è½½å’ŒæŸ¥çœ‹
# 6. æäº¤å¹¶æ¨é€å·¥ä½œæµæ–‡ä»¶åˆ°é»˜è®¤åˆ†æ”¯ä»¥è§¦å‘å·¥ä½œæµè¿è¡Œã€‚

# ğŸ‘‹ è®¿é—®æˆ‘ä»¬çš„ GitHub ç»„ç»‡ https://github.com/redhat-actions/ æŸ¥çœ‹æˆ‘ä»¬çš„æ“ä½œå¹¶æä¾›åé¦ˆã€‚

name: CRDA æ‰«æ

# æ§åˆ¶å·¥ä½œæµä½•æ—¶è¿è¡Œ
on:
  # TODO: æ ¹æ®æ‚¨çš„ DevSecOps æµç¨‹è‡ªå®šä¹‰è§¦å‘äº‹ä»¶
  #
  # æ­¤å·¥ä½œæµæ˜¯ä¸ºä¸ OpenShift å…¥é—¨å·¥ä½œæµä¸€èµ·è¿è¡Œè€Œåˆ¶ä½œçš„
  # https://github.com/actions/starter-workflows/blob/main/deployments/openshift.yml
  # ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³å°†æ­¤å·¥ä½œæµä½œä¸ºç‹¬ç«‹å·¥ä½œæµè¿è¡Œï¼Œè¯·å–æ¶ˆä¸‹é¢çš„ 'push' è§¦å‘å™¨çš„æ³¨é‡Šï¼Œå¹¶æ ¹æ®æ‚¨çš„è¦æ±‚è¿›è¡Œé…ç½®ã€‚
  #
  workflow_call:
    secrets:
      CRDA_KEY:
        required: false
      SNYK_TOKEN:
        required: false
  workflow_dispatch:

  # push:
  #   branches: [ $default-branch, $protected-branches ]

  # pull_request_target ç”¨äºå®‰å…¨åœ°å…±äº«å¯†é’¥ç»™ PR çš„å·¥ä½œæµè¿è¡Œã€‚
  # æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼šhttps://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target
  pull_request_target:
    branches: [ $default-branch ]
    types: [ assigned, opened, synchronize, reopened, labeled, edited ]

permissions:
  contents: read

jobs:
  crda-scan:
    permissions:
      contents: read            # ç”¨äº actions/checkout è·å–ä»£ç 
      security-events: write    # ç”¨äº redhat-actions/crda ä¸Šä¼  SARIF ç»“æœ
    name: ä½¿ç”¨ CRDA æ‰«æé¡¹ç›®æ¼æ´
    runs-on: ubuntu-20.04
    steps:

      - name: æ£€å‡ºå­˜å‚¨åº“
        uses: actions/checkout@v2

      # *******************************************************************
      # å¿…éœ€ï¼šè®¾ç½®é¡¹ç›®çš„è¯´æ˜ä¹¦
      # 1. æ ¹æ®é¡¹ç›®çš„ç±»å‹è®¾ç½® Goã€Javaã€Node.js æˆ– Python
      # 2. ä¸‹é¢åˆ—å‡ºçš„è®¾ç½®æ“ä½œï¼Œè¯·ä»ä¸­é€‰æ‹©ä¸€ä¸ªï¼š
      #    - Go: https://github.com/actions/setup-go
      #    - Java: https://github.com/actions/setup-java
      #    - Node.js: https://github.com/actions/setup-node
      #    - Python: https://github.com/actions/setup-python
      #
      # ç¤ºä¾‹ï¼š
      # - name: è®¾ç½® Node
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: '14'

      # https://github.com/redhat-actions/openshift-tools-installer/blob/main/README.md
      - name: å®‰è£… CRDA CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: github
          github_pat: ${{ github.token }}
          # é€‰æ‹©æ‰€éœ€ç‰ˆæœ¬çš„ CRDA CLI
          crda: "latest"

      ######################################################################################
      # https://github.com/redhat-actions/crda/blob/main/README.md
      #
      # é»˜è®¤æƒ…å†µä¸‹ï¼ŒCRDA å°†æ£€æµ‹æ¸…å•æ–‡ä»¶å¹¶ä½¿ç”¨é¡¹ç›®ç±»å‹çš„æ ‡å‡†å‘½ä»¤å®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚
      # å¦‚æœæ‚¨çš„é¡¹ç›®ä¸æ­¤æ“ä½œä¸­æåˆ°çš„é»˜è®¤è®¾ç½®ä¸ç¬¦ï¼Œåˆ™éœ€è¦è®¾ç½®æ­¤å¤„æè¿°çš„ä¸€äº›è¾“å…¥ï¼š
      # https://github.com/redhat-actions/crda/blob/main/README.md#3-installing-dependencies
      # è®¿é—® https://github.com/redhat-actions/crda/#4-set-up-authentication äº†è§£
      # è·å– SNYK_TOKEN æˆ– CRDA_KEY çš„è¿‡ç¨‹
      - name: CRDA æ‰«æ
        id: scan
        uses: redhat-actions/crda@v1
        with:
          crda_key: ${{ secrets.CRDA_KEY }}           # ä½¿ç”¨ crda_key æˆ– snyk_token ä¸­çš„ä¸€ä¸ª
          # snyk_token: ${{ secrets.SNYK_TOKEN }}
          # upload_artifact: false                    # å°†æ­¤è®¾ç½®ä¸º false ä»¥è·³è¿‡æ„ä»¶ä¸Šä¼ 
